<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>StoryLens – Turn Images Into Stories</title>
  <link rel="icon" href="/public/storylens.png" type="image/png">
  <style>
    :root {
      --page-bg: #f8f5e7;        /* soft paper background */
      --card: #fdfaf2;           /* light cream card */
      --ink: #2c2b27;            /* book ink text */
      --muted: #6b6456;          /* aged gray-brown */
      --border: #e4dfd2;         /* parchment edge tone */
      --accent: #6e5334;         /* warm brown accent */
      --accentH: #8a6b47;        /* hover accent */
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Georgia', 'Times New Roman', serif;
      background: var(--page-bg);
      color: var(--ink);
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      background-image: radial-gradient(rgba(255,255,255,0.3) 1px, transparent 1px);
      background-size: 40px 40px;
    }

    header {
      text-align: center;
      margin-top: 60px;
      padding: 0 16px;
    }

    h1 {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 2.3rem;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      color: var(--ink);
    }

    p.subtitle {
      font-size: 1.1rem;
      color: var(--muted);
      margin-bottom: 40px;
    }

    main {
      background: var(--card);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 28px;
      width: 92%;
      max-width: 640px;
      transition: transform 0.3s;
    }

    main:hover { transform: translateY(-2px); }

    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    input[type="file"] { display: none; }

    label.upload-btn {
      background: var(--accent);
      color: #fff;
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-size: .95rem;
      font-family: 'Inter', sans-serif;
      letter-spacing: 0.3px;
    }

    label.upload-btn:hover { background: var(--accentH); }

    button {
      padding: 10px 16px;
      border-radius: 10px;
      border: none;
      background: var(--accent);
      color: #fff;
      font-size: .95rem;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      letter-spacing: 0.3px;
    }

    button:hover { background: var(--accentH); }

    .preview {
      margin-top: 16px;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      background: #fbf9ef;
      display: flex;
      gap: 14px;
      align-items: flex-start;
    }

    .preview img {
      max-width: 180px;
      max-height: 180px;
      border-radius: 10px;
      object-fit: cover;
      background: #ddd;
    }

    .preview .meta {
      color: var(--muted);
      font-size: .9rem;
      line-height: 1.35;
      font-family: 'Inter', sans-serif;
    }

    #out {
      white-space: pre-wrap;
      text-align: left;
      margin-top: 16px;
      background: #fcfaef;
      border-radius: 12px;
      padding: 18px;
      min-height: 160px;
      border: 1px solid var(--border);
      box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.04);
      line-height: 1.55;
      font-family: 'Georgia', serif;
      font-size: 1rem;
    }

    .loading { animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% {opacity:.5} 50% {opacity:1} 100% {opacity:.5} }

    footer {
      margin-top: auto;
      padding: 26px 0 40px;
      text-align: center;
      font-size: .9rem;
      color: var(--muted);
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>

<body>
  <header>
    <h1>StoryLens</h1>
    <p class="subtitle">Transform any image into a vivid short story.</p>
  </header>

  <main>
    <div class="controls">
      <input type="file" id="file" accept="image/*">
      <label for="file" class="upload-btn">Choose Image</label>
      <button id="go" onclick="main()">Make Story</button>
    </div>

    <!-- Image preview block -->
    <div id="preview" class="preview" style="display:none">
      <img id="thumb" alt="Selected image preview" />
      <div class="meta" id="meta"></div>
    </div>

    <div id="out">Upload an image and click <strong>Make Story</strong> to begin.</div>
  </main>

  <footer>
    © <span id="year"></span> StoryLens.art — Crafted with imagination
  </footer>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();
    const api = window.location.origin;

    const fileInput = document.getElementById("file");
    const preview = document.getElementById("preview");
    const thumb = document.getElementById("thumb");
    const meta = document.getElementById("meta");
    const out = document.getElementById("out");

    function show(msg, loading=false) {
      out.textContent = msg;
      out.className = loading ? "loading" : "";
    }

    let lastURL = null;
    fileInput.addEventListener("change", () => {
      const f = fileInput.files && fileInput.files[0];
      if (!f) { preview.style.display = "none"; return; }
      if (lastURL) URL.revokeObjectURL(lastURL);
      lastURL = URL.createObjectURL(f);
      thumb.src = lastURL;
      meta.textContent = `${f.name}\n${f.type || "unknown"} • ${(f.size/1024/1024).toFixed(2)} MB`;
      preview.style.display = "flex";
      show("Ready — click Make Story.");
    });

    async function requestUploadURL(f) {
      const res = await fetch(api + "/upload-url", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ filename: f.name, content_type: f.type })
      });
      if (!res.ok) throw new Error(`upload-url ${res.status}: ${await res.text()}`);
      const data = await res.json();
      if (!data.put_url || !data.key) throw new Error("upload-url missing fields");
      return data;
    }

    async function uploadToS3(putURL, file) {
      const r = await fetch(putURL, { method:"PUT", body:file, headers: { "Content-Type": file.type } });
      if (!r.ok) throw new Error(`S3 PUT ${r.status}: ${await r.text()}`);
    }

    async function generateStory(key) {
      const r = await fetch(api + "/generate?key=" + encodeURIComponent(key));
      const t = await r.text();
      if (!r.ok) throw new Error(`generate ${r.status}: ${t}`);
      const data = JSON.parse(t);
      if (!data.story) throw new Error("No story in response.");
      return data.story;
    }

    window.main = async function () {
      try {
        const f = fileInput.files && fileInput.files[0];
        if (!f) { alert("Please choose an image first."); return; }

        show("Requesting upload URL…", true);
        const up = await requestUploadURL(f);

        show("Uploading image to cloud…", true);
        await uploadToS3(up.put_url, f);

        show("Creating story with your image…", true);
        const story = await generateStory(up.key);

        show(story);
      } catch (e) {
        console.error(e);
        show("Error: " + (e?.message || e));
      }
    };
  </script>
</body>
</html>
