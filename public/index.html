<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Image → Story (Claude)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;max-width:720px;margin:40px auto;padding:0 16px}
    h1{font-size:22px;margin-bottom:12px}
    #out{white-space:pre-wrap;border:1px solid #ddd;padding:12px;border-radius:8px;min-height:120px;margin-top:12px}
    button{padding:8px 14px;border-radius:8px;border:1px solid #ccc;background:#f6f6f6;cursor:pointer}
    button:hover{background:#eee}
  </style>
</head>
<body>
  <h1>Image → Story (Claude)</h1>

  <input type="file" id="file" accept="image/*">
<button id="go" onclick="main()">Make Story</button>
<div id="out">Pick an image and click “Make Story”.</div>

<script>
  // Use same origin as the API since the page is served by FastAPI
  const api = window.location.origin;

  function show(msg) {
    const out = document.getElementById("out");
    if (out) out.textContent = msg;
  }

  // Make main global so the inline onclick can see it
  window.main = async function () {
    try {
      const fileInput = document.getElementById("file");
      const f = fileInput && fileInput.files && fileInput.files[0];
      if (!f) { alert("Pick an image first."); return; }

      show("Requesting upload URL...");
      const upRes = await fetch(api + "/upload-url", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ filename: f.name, content_type: f.type })
      });
      const upText = await upRes.text();
      if (!upRes.ok) throw new Error(`upload-url ${upRes.status}: ${upText}`);
      let up;
      try { up = JSON.parse(upText); } catch { throw new Error("upload-url non-JSON: " + upText); }
      if (!up.put_url || !up.key) throw new Error("upload-url missing put_url/key");

      show("Uploading to S3...");
      const putRes = await fetch(up.put_url, { method: "PUT", body: f, headers: { "Content-Type": f.type } });
      if (!putRes.ok) {
        const t = await putRes.text();
        throw new Error(`S3 PUT ${putRes.status}: ${t}`);
      }

      show("Generating story with Claude...");
      const genRes = await fetch(api + "/generate?key=" + encodeURIComponent(up.key));
      const genText = await genRes.text();
      if (!genRes.ok) throw new Error(`generate ${genRes.status}: ${genText}`);
      let data;
      try { data = JSON.parse(genText); } catch { throw new Error("generate non-JSON: " + genText); }
      if (!data.story) throw new Error("No story in response.");
      show(data.story);
    } catch (e) {
      console.error(e);
      show("Error: " + (e?.message || e));
    }
  };
</script>
</body>
</html>
