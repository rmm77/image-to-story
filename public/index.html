<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>StoryLens â€“ Turn Images Into Stories</title>
  <link rel="icon" href="/public/storylens.png" type="image/png">

  <style>
    /* ---------- Base (Day / Paperback) Palette ---------- */
    :root {
      --page-bg: #f8f5e7;
      --card: #fdfaf2;
      --ink: #2c2b27;
      --muted: #6b6456;
      --border: #e4dfd2;
      --accent: #6e5334;
      --accentH: #8a6b47;
      --paper-grain: radial-gradient(rgba(255,255,255,0.3) 1px, transparent 1px);
    }

    /* ---------- Night / Sepia Mode Palette ---------- */
    body[data-theme="night"] {
      --page-bg: #1f1a14;
      --card: #2a231c;
      --ink: #efe7d7;
      --muted: #c7bba7;
      --border: #3a3128;
      --accent: #cda677;
      --accentH: #e3be8d;
      --paper-grain: radial-gradient(rgba(255,255,255,0.05) 1px, transparent 1px);
    }

    * { box-sizing: border-box; }

    html, body { height: 100%; }

    body {
      font-family: 'Georgia', 'Times New Roman', serif;
      background: var(--page-bg);
      color: var(--ink);
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background-image: var(--paper-grain);
      background-size: 40px 40px;
      transition: background-color .25s ease, color .25s ease;
    }

    /* Centered page wrapper */
    .page {
      flex: 1;
      width: 100%;
      max-width: 960px;
      margin: 0 auto;
      padding: 40px 16px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    header {
      width: 100%;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 8px;
      text-align: center;
      margin-bottom: 24px;
    }

    .header-spacer { height: 1px; }

    h1 {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 2.3rem;
      letter-spacing: 0.5px;
      margin: 0;
    }

    p.subtitle {
      grid-column: 1 / -1;
      font-size: 1.1rem;
      color: var(--muted);
      margin: 8px 0 0;
      text-align: center;
    }

    /* ---------- Theme Toggle ---------- */
    .toggle-wrap {
      justify-self: end;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-family: 'Inter', sans-serif;
    }

    .toggle-btn {
      position: relative;
      width: 48px; height: 28px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--card);
      cursor: pointer;
    }

    .toggle-knob {
      position: absolute;
      top: 2px; left: 2px;
      width: 24px; height: 24px;
      border-radius: 50%;
      background: var(--accent);
      transition: transform .25s ease;
    }

    body[data-theme="night"] .toggle-knob {
      transform: translateX(20px);
    }

    /* ---------- MAIN CONTENT ---------- */
    main {
      background: var(--card);
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 28px;
      width: 100%;
      max-width: 700px;
      margin-bottom: 30px;
      transition: background-color .25s ease, border-color .25s ease;
    }

    .controls {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 10px;
      align-items: center;
      font-family: 'Inter', sans-serif;
    }

    @media (max-width: 640px) {
      .controls { grid-template-columns: 1fr; }
    }

    input[type="file"] { display: none; }

    label.upload-btn, button, select {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      font-size: .95rem;
    }

    label.upload-btn:hover,
    button:hover {
      background: var(--accentH);
    }

    /* subtle secondary button look for copy */
    .secondary-btn {
      background: transparent;
      color: var(--accent);
      border-color: var(--accent);
      font-size: .85rem;
      padding: 8px 12px;
    }

    .secondary-btn:hover {
      background: var(--accent);
      color: #fff;
    }

    select {
      background: color-mix(in oklab, var(--card), black 8%);
      color: var(--ink);
    }

    .select-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .select-label {
      color: var(--muted);
      font-size: .9rem;
    }

    /* ---------- PREVIEW (fixed layout) ---------- */
    .preview {
      margin-top: 16px;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      background: color-mix(in oklab, var(--card), black 2%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .preview img {
      display: block;
      max-width: 100%;
      height: auto;
      border-radius: 10px;
    }

    .preview .meta {
      align-self: flex-start;
      color: var(--muted);
      font-size: .9rem;
      white-space: pre-line;
      word-break: break-word;
      font-family: 'Inter', sans-serif;
    }

    /* ---------- Story Output ---------- */
    #out {
      margin-top: 16px;
      background: color-mix(in oklab, var(--card), white 4%);
      border-radius: 12px;
      padding: 18px;
      min-height: 160px;
      border: 1px solid var(--border);
      line-height: 1.55;
      white-space: pre-wrap;
      font-family: 'Georgia', serif;
    }

    /* copy button container */
    .copy-row {
      margin-top: 8px;
      display: flex;
      justify-content: flex-end;
    }

    /* ---------- Flashing Loading Animation ---------- */
    .loading {
      animation: pulse 1.4s ease-in-out infinite;
    }

    @keyframes pulse {
      0%   { opacity: 0.45; }
      50%  { opacity: 1; }
      100% { opacity: 0.45; }
    }

    /* ---------- Footer ---------- */
    footer {
      text-align: center;
      padding: 20px 0 40px;
      font-size: .9rem;
      color: var(--muted);
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>

<body>
  <div class="page">
    <header>
      <div class="header-spacer"></div>

      <div><h1>StoryLens</h1></div>

      <div class="toggle-wrap" title="Toggle night mode">
        <span id="emoji">ðŸŒž</span>
        <div class="toggle-btn" id="themeToggle">
          <div class="toggle-knob"></div>
        </div>
      </div>

      <p class="subtitle">Transform any image into a vivid short story.</p>
    </header>

    <main>
      <div class="controls">
        <!-- File Upload -->
        <div>
          <input type="file" id="file" accept="image/*">
          <label for="file" class="upload-btn">Choose Image</label>
        </div>

        <!-- Style Selector -->
        <div class="select-wrap">
          <span class="select-label">Style:</span>
          <select id="styleSel">
            <option>Whimsical</option>
            <option>Noir</option>
            <option>Epic</option>
            <option>Cozy</option>
            <option>Sci-Fi</option>
            <option>Fantasy</option>
            <option>Action</option>
            <option>Romance</option>
            <option>Mystery</option>
            <option>Historical</option>
            <option>Magical Realism</option>
          </select>
        </div>

        <!-- Length Selector -->
        <div class="select-wrap">
          <span class="select-label">Length:</span>
          <select id="lenSel">
            <option value="300-500">Short</option>
            <option value="600-1000" selected>Medium</option>
            <option value="1400-2000">Long</option>
          </select>
        </div>

        <!-- Generate Button -->
        <button onclick="main()">Make Story</button>
      </div>

      <!-- Image Preview -->
      <div id="preview" class="preview" style="display:none">
        <img id="thumb" alt="Preview">
        <div class="meta" id="meta"></div>
      </div>

      <div id="out">
        Upload an image, choose your style and length, then click <strong>Make Story</strong>.
      </div>

      <div class="copy-row">
        <button id="copyBtn" type="button" class="secondary-btn" onclick="copyStory()">
          Copy Story
        </button>
      </div>
    </main>
  </div>

  <footer>Â© 2025 StoryLens.art â€” Crafted with imagination.</footer>

  <script>
    const body = document.body;
    const toggle = document.getElementById("themeToggle");
    const emoji = document.getElementById("emoji");

    function setTheme(mode){
      if(mode==="night"){
        body.setAttribute("data-theme","night");
        emoji.textContent="ðŸŒ™";
        localStorage.setItem("storylens-theme","night");
      } else {
        body.removeAttribute("data-theme");
        emoji.textContent="ðŸŒž";
        localStorage.setItem("storylens-theme","day");
      }
    }

    const saved = localStorage.getItem("storylens-theme");
    if(saved==="night") setTheme("night");

    toggle.onclick = () => {
      const isNight = body.getAttribute("data-theme")==="night";
      setTheme(isNight ? "day" : "night");
    };

    const api = window.location.origin;
    const fileInput = document.getElementById("file");
    const styleSel  = document.getElementById("styleSel");
    const lenSel    = document.getElementById("lenSel");
    const preview   = document.getElementById("preview");
    const thumb     = document.getElementById("thumb");
    const meta      = document.getElementById("meta");
    const out       = document.getElementById("out");
    const copyBtn   = document.getElementById("copyBtn");

    const STYLE_MAP = {
      "Whimsical": "whimsical, playful, light magical touches, gentle humor",
      "Noir": "noir, moody, tense, smoky atmosphere",
      "Epic": "epic, sweeping, elevated diction",
      "Cozy": "cozy, warm, comforting, intimate tone",
      "Sci-Fi": "science fiction, speculative, sense of wonder",
      "Fantasy": "fantasy, mythic, lyrical, enchanted",
      "Action": "fast-paced, kinetic, high stakes",
      "Romance": "romantic, tender, emotional",
      "Mystery": "mystery, investigative, tense and curious",
      "Historical": "historical, grounded, era-accurate texture",
      "Magical Realism": "magical realism, subtle surrealism, poetic"
    };

    function show(msg, loading=false){
      out.textContent = msg;
      out.className = loading ? "loading" : "";
    }

    let lastURL = null;

    fileInput.onchange = () => {
      const f = fileInput.files[0];
      if (!f) { preview.style.display="none"; return; }

      if(lastURL) URL.revokeObjectURL(lastURL);
      lastURL = URL.createObjectURL(f);

      thumb.src = lastURL;
      meta.textContent = `${f.name}\n${f.type || ""} â€¢ ${(f.size/1024/1024).toFixed(2)} MB`;
      preview.style.display = "flex";

      show("Ready â€” click Make Story.");
    };

    async function requestUploadURL(f){
      const r = await fetch(api+"/upload-url",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ filename:f.name, content_type:f.type })
      });
      return r.json();
    }

    async function main(){
      try {
        const f = fileInput.files[0];
        if(!f) return alert("Choose an image first.");

        const style = STYLE_MAP[styleSel.value];
        const length_hint = lenSel.value;

        show("Requesting upload URLâ€¦", true);
        const up = await requestUploadURL(f);

        await fetch(up.put_url, {
          method:"PUT",
          body: f,
          headers: { "Content-Type": f.type }
        });

        show("Creating your storyâ€¦", true);

        const r = await fetch(
          api + "/generate?key=" + encodeURIComponent(up.key)
          + "&style=" + encodeURIComponent(style)
          + "&length_hint=" + encodeURIComponent(length_hint)
        );

        const data = await r.json();
        show(data.story, false);

      } catch(e) {
        show("Error: " + e.message, false);
      }
    }

    // ---------- Copy Story to Clipboard ----------
    function copyStory() {
      const text = out.textContent.trim();

      // Basic check so people don't copy helper/loading/error text
      if (!text ||
          text.startsWith("Upload an image") ||
          text.startsWith("Ready â€”") ||
          text.startsWith("Requesting upload URL") ||
          text.startsWith("Creating your storyâ€¦") ||
          text.startsWith("Error:")) {
        alert("There isn't a finished story to copy yet.");
        return;
      }

      const labelDefault = "Copy Story";

      function setLabel(msg) {
        copyBtn.textContent = msg;
        setTimeout(() => { copyBtn.textContent = labelDefault; }, 1500);
      }

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text)
          .then(() => setLabel("Copied!"))
          .catch(() => {
            setLabel("Copy failed");
          });
      } else {
        // Fallback for older browsers
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        try {
          document.execCommand("copy");
          setLabel("Copied!");
        } catch {
          setLabel("Copy failed");
        }
        document.body.removeChild(ta);
      }
    }
  </script>
</body>
</html>
