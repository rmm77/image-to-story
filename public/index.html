<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>StoryLens â€“ Turn Images Into Stories</title>
  <link rel="icon" href="/public/storylens.png" type="image/png">
  <style>
    /* ---------- Base (Day / Paperback) Palette ---------- */
    :root {
      --page-bg: #f8f5e7;        /* soft paper background */
      --card: #fdfaf2;           /* light cream card */
      --ink: #2c2b27;            /* book ink text */
      --muted: #6b6456;          /* aged gray-brown */
      --border: #e4dfd2;         /* parchment edge tone */
      --accent: #6e5334;         /* warm brown accent */
      --accentH: #8a6b47;        /* hover accent */
      --paper-grain: radial-gradient(rgba(255,255,255,0.3) 1px, transparent 1px);
    }

    /* ---------- Night / Sepia Mode Palette ---------- */
    body[data-theme="night"] {
      --page-bg: #1f1a14;        /* deep coffee brown */
      --card: #2a231c;           /* dark parchment */
      --ink: #efe7d7;            /* warm ink on dark */
      --muted: #c7bba7;          /* mellow sepia text */
      --border: #3a3128;         /* subtle border */
      --accent: #cda677;         /* warm brass accent */
      --accentH: #e3be8d;        /* brighter hover */
      --paper-grain: radial-gradient(rgba(255,255,255,0.05) 1px, transparent 1px);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      font-family: 'Georgia', 'Times New Roman', serif;
      background: var(--page-bg);
      color: var(--ink);
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      background-image: var(--paper-grain);
      background-size: 40px 40px;
      transition: background-color .25s ease, color .25s ease;
    }

    header {
      text-align: center;
      margin-top: 48px;
      padding: 0 16px;
      width: 100%;
      max-width: 920px;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 8px;
    }

    /* Center the title; toggle sits right */
    .header-spacer { height: 1px; }
    h1 {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 2.3rem;
      letter-spacing: 0.5px;
      margin: 0 0 8px 0;
    }
    p.subtitle {
      grid-column: 1 / -1;
      font-size: 1.1rem;
      color: var(--muted);
      margin: 8px 0 28px 0;
      text-align: center;
    }

    /* Theme toggle */
    .toggle-wrap {
      justify-self: end;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-family: 'Inter', system-ui, -apple-system, Roboto, Arial, sans-serif;
    }
    .toggle-btn {
      position: relative;
      width: 48px; height: 28px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--card);
      box-shadow: inset 0 0 0 2px rgba(0,0,0,0.02);
      cursor: pointer;
      transition: background .2s ease, border-color .2s ease;
    }
    .toggle-knob {
      position: absolute; top: 2px; left: 2px;
      width: 24px; height: 24px; border-radius: 50%;
      background: var(--accent);
      transition: transform .25s ease, background .25s ease;
    }
    body[data-theme="night"] .toggle-knob {
      transform: translateX(20px);
      background: var(--accent);
    }
    .toggle-emoji { user-select: none; font-size: 18px; }

    main {
      background: var(--card);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 28px;
      width: 92%;
      max-width: 640px;
      transition: transform 0.3s, background-color .25s ease, border-color .25s ease;
    }
    main:hover { transform: translateY(-2px); }

    .controls {
      display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
      font-family: 'Inter', system-ui, -apple-system, Roboto, Arial, sans-serif;
    }

    input[type="file"] { display: none; }

    label.upload-btn, button {
      padding: 10px 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--accent);
      color: #fff;
      font-size: .95rem;
      cursor: pointer;
      letter-spacing: 0.3px;
      transition: background-color .2s ease, border-color .2s ease;
    }
    label.upload-btn:hover, button:hover { background: var(--accentH); }

    .preview {
      margin-top: 16px;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      background: color-mix(in oklab, var(--card), black 2%);
      display: flex;
      gap: 14px;
      align-items: flex-start;
      transition: background-color .25s ease, border-color .25s ease;
    }

    .preview img {
      max-width: 180px; max-height: 180px;
      border-radius: 10px; object-fit: cover; background: #ddd;
    }

    .preview .meta {
      color: var(--muted);
      font-size: .9rem;
      line-height: 1.35;
      font-family: 'Inter', system-ui, -apple-system, Roboto, Arial, sans-serif;
      white-space: pre-line;
    }

    #out {
      white-space: pre-wrap;
      text-align: left;
      margin-top: 16px;
      background: color-mix(in oklab, var(--card), white 4%);
      border-radius: 12px;
      padding: 18px;
      min-height: 160px;
      border: 1px solid var(--border);
      box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.04);
      line-height: 1.55;
      font-family: 'Georgia', serif;
      font-size: 1rem;
      transition: background-color .25s ease, border-color .25s ease;
    }

    .loading { animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% {opacity:.5} 50% {opacity:1} 100% {opacity:.5} }

    footer {
      margin-top: auto;
      padding: 26px 0 40px;
      text-align: center;
      font-size: .9rem;
      color: var(--muted);
      font-family: 'Inter', system-ui, -apple-system, Roboto, Arial, sans-serif;
    }
  </style>
</head>

<body>
  <header>
    <div class="header-spacer"></div>

    <div>
      <h1>StoryLens</h1>
    </div>

    <div class="toggle-wrap" title="Toggle night reading mode">
      <span class="toggle-emoji" id="emoji">ðŸŒž</span>
      <div class="toggle-btn" id="themeToggle" role="switch" aria-checked="false" tabindex="0">
        <div class="toggle-knob"></div>
      </div>
    </div>

    <p class="subtitle">Transform any image into a vivid short story.</p>
  </header>

  <main>
    <div class="controls">
      <input type="file" id="file" accept="image/*">
      <label for="file" class="upload-btn">Choose Image</label>
      <button id="go" onclick="main()">Make Story</button>
    </div>

    <!-- Image preview block -->
    <div id="preview" class="preview" style="display:none">
      <img id="thumb" alt="Selected image preview" />
      <div class="meta" id="meta"></div>
    </div>

    <div id="out">Upload an image and click <strong>Make Story</strong> to begin.</div>
  </main>

  <footer>
    Â© <span id="year"></span> StoryLens.art â€” Crafted with imagination
  </footer>

  <script>
    // ---------- Utilities ----------
    document.getElementById("year").textContent = new Date().getFullYear();
    const api = window.location.origin;

    // Theme state
    const body = document.body;
    const toggle = document.getElementById('themeToggle');
    const emoji = document.getElementById('emoji');

    // Init from saved pref or system
    (function initTheme(){
      const saved = localStorage.getItem('storylens-theme');
      if (saved === 'night' || (!saved && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        setTheme('night');
      } else {
        setTheme('day');
      }
    })();

    function setTheme(mode) {
      if (mode === 'night') {
        body.setAttribute('data-theme','night');
        toggle.setAttribute('aria-checked','true');
        emoji.textContent = 'ðŸŒ™';
        localStorage.setItem('storylens-theme','night');
      } else {
        body.removeAttribute('data-theme');
        toggle.setAttribute('aria-checked','false');
        emoji.textContent = 'ðŸŒž';
        localStorage.setItem('storylens-theme','day');
      }
    }

    function toggleTheme() {
      const isNight = body.getAttribute('data-theme') === 'night';
      setTheme(isNight ? 'day' : 'night');
    }

    toggle.addEventListener('click', toggleTheme);
    toggle.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleTheme(); }
    });

    // ---------- App Logic ----------
    const fileInput = document.getElementById("file");
    const preview = document.getElementById("preview");
    const thumb = document.getElementById("thumb");
    const meta = document.getElementById("meta");
    const out = document.getElementById("out");

    function show(msg, loading=false) {
      out.textContent = msg;
      out.className = loading ? "loading" : "";
    }

    // Image preview
    let lastURL = null;
    fileInput.addEventListener("change", () => {
      const f = fileInput.files && fileInput.files[0];
      if (!f) { preview.style.display = "none"; return; }
      if (lastURL) URL.revokeObjectURL(lastURL);
      lastURL = URL.createObjectURL(f);
      thumb.src = lastURL;
      meta.textContent = `${f.name}\n${f.type || "unknown"} â€¢ ${(f.size/1024/1024).toFixed(2)} MB`;
      preview.style.display = "flex";
      show("Ready â€” click Make Story.");
    });

    async function requestUploadURL(f) {
      const res = await fetch(api + "/upload-url", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ filename: f.name, content_type: f.type })
      });
      if (!res.ok) throw new Error(`upload-url ${res.status}: ${await res.text()}`);
      const data = await res.json();
      if (!data.put_url || !data.key) throw new Error("upload-url missing fields");
      return data;
    }

    async function uploadToS3(putURL, file) {
      const r = await fetch(putURL, { method:"PUT", body:file, headers: { "Content-Type": file.type } });
      if (!r.ok) throw new Error(`S3 PUT ${r.status}: ${await r.text()}`);
    }

    async function generateStory(key) {
      const r = await fetch(api + "/generate?key=" + encodeURIComponent(key));
      const t = await r.text();
      if (!r.ok) throw new Error(`generate ${r.status}: ${t}`);
      const data = JSON.parse(t);
      if (!data.story) throw new Error("No story in response.");
      return data.story;
    }

    window.main = async function () {
      try {
        const f = fileInput.files && fileInput.files[0];
        if (!f) { alert("Please choose an image first."); return; }

        show("Requesting upload URLâ€¦", true);
        const up = await requestUploadURL(f);

        show("Uploading image to cloudâ€¦", true);
        await uploadToS3(up.put_url, f);

        show("Creating story with your imageâ€¦", true);
        const story = await generateStory(up.key);

        show(story);
      } catch (e) {
        console.error(e);
        show("Error: " + (e?.message || e));
      }
    };
  </script>
</body>
</html>
